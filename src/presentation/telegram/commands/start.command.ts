/**
 * @file start.command.ts
 * @brief –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start.
 *
 * –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –µ–≥–æ –≤ —Å–∏—Å—Ç–µ–º–µ.
 */

import { BotContext } from '../types';
import { UserService } from '../../../domain/services/UserService/user.service';
import { getErrorHandler } from '../../../infrastructure/errors';

/**
 * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
 */
export function createStartCommand(userService: UserService) {
  return async (ctx: BotContext): Promise<void> => {
    const errorHandler = getErrorHandler();

    try {
      const telegramUser = ctx.from;
      if (!telegramUser) {
        await ctx.reply('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ.');
        return;
      }

      // –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
      const dbUser = await userService.getOrCreateUser(
        telegramUser.id.toString(),
        telegramUser.first_name || telegramUser.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
      );

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
      ctx.dbUser = dbUser;

      // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      const welcomeMessage = `
üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Bandboats!

–Ø –±–æ—Ç —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∏. –í—ã –º–æ–∂–µ—Ç–µ:

üìù –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–∏–∫–µ—Ç - /newticket
üìã –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–∏ —Ç–∏–∫–µ—Ç—ã - /mytickets
‚ÑπÔ∏è –ü–æ–ª—É—á–∏—Ç—å –ø–æ–º–æ—â—å - /help

${dbUser.isAdmin() ? '\nüëë –í—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä!\nüé´ –í—Å–µ —Ç–∏–∫–µ—Ç—ã - /alltickets\n' : ''}
      `.trim();

      await ctx.reply(welcomeMessage);
    } catch (error) {
      const message = errorHandler.handle(error as Error, {
        command: 'start',
        userId: ctx.from?.id,
      });
      await ctx.reply(message);
    }
  };
}
